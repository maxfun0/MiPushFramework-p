name: Android Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: gradle
      
      - name: Create debug keystore
        run: |
          # 创建调试密钥库
          keytool -genkeypair -v \
            -keystore debug.keystore \
            -alias androiddebugkey \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass android \
            -keypass android \
            -dname "CN=Android Debug,O=Android,C=US"
          
          # 复制为项目可能需要的文件名
          cp debug.keystore .yuuta.jks
          
          echo "密钥库创建完成"
      
      - name: Setup Gradle
        run: |
          chmod +x gradlew
          # 显示Gradle版本
          ./gradlew --version
      
      - name: Validate Gradle wrapper
        run: |
          # 验证Gradle包装器
          ./gradlew help
      
      - name: Build specific variant
        run: |
          echo "开始构建 vc105Debug 变体..."
          
          # 只构建特定的变体，减少复杂度
          ./gradlew :push:assembleVc105Debug \
            --no-daemon \
            --no-parallel \
            --stacktrace
          
          echo "构建完成"
      
      - name: Check build results
        if: success()
        run: |
          echo "=== 检查构建结果 ==="
          
          # 检查push模块的APK
          if [ -d "push/build/outputs/apk" ]; then
            echo "APK目录内容:"
            find push/build/outputs/apk -name "*.apk" -type f
            echo ""
            echo "复制APK文件..."
            mkdir -p artifacts
            find push/build/outputs/apk -name "*.apk" -type f -exec cp {} artifacts/ \;
          fi
          
          echo "=== 所有文件 ==="
          ls -la artifacts/ 2>/dev/null || echo "artifacts目录不存在"
      
      - name: Upload APK artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: artifacts/
          retention-days: 7
      
      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-failure-logs
          path: |
            **/build/reports/
            **/build/outputs/logs/
          retention-days: 7
