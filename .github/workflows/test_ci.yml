name: Test CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-debug:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: gradle
    
    - name: Build without signing
      run: |
        # 使用 -Pandroid.injected.signing.store.file 参数传递空值来禁用签名
        ./gradlew assembleDebug \
          -PversionName=$(git describe --tags --exact-match 2>/dev/null || echo "dev-$(date +%Y%m%d)") \
          -Pandroid.injected.signing.store.file="" \
          -Pandroid.injected.signing.store.password="" \
          -Pandroid.injected.signing.key.alias="" \
          -Pandroid.injected.signing.key.password="" \
          --no-daemon
        
        echo "Build completed. APK files:"
        find . -name "*.apk" -type f
    
    - name: Collect APKs
      run: |
        mkdir -p apk_collected
        
        # 收集 normal 变体的 debug APK
        if ls push/build/outputs/apk/normal/debug/*.apk 2>/dev/null; then
          cp push/build/outputs/apk/normal/debug/*.apk apk_collected/
        fi
        
        # 收集 vc105 变体的 debug APK
        if ls push/build/outputs/apk/vc105/debug/*.apk 2>/dev/null; then
          cp push/build/outputs/apk/vc105/debug/*.apk apk_collected/
        fi
        
        echo "Collected APKs:"
        ls -la apk_collected/
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: debug-apks
        path: apk_collected/
        if-no-files-found: error
