name: Test CI

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate version name
        id: version
        run: |
          git fetch --tags --force || true
          
          if git describe --tags --exact-match >/dev/null 2>&1; then
            VERSION=$(git describe --tags --exact-match)
            echo "is_release=true" >> $GITHUB_ENV
          else
            # 从项目配置获取版本
            COMMIT_HASH=$(git rev-parse --short HEAD)
            VERSION="dev-$COMMIT_HASH"
            echo "is_release=false" >> $GITHUB_ENV
          fi
          
          CLEAN_VERSION=$(echo "$VERSION" | sed 's/^v//')
          echo "version=${CLEAN_VERSION}" >> $GITHUB_OUTPUT
          echo "VERSION_NAME=${CLEAN_VERSION}" >> $GITHUB_ENV

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: gradle

      - name: Create debug keystore as .yuuta.jks
        run: |
          echo "创建调试密钥库..."
          
          # 删除可能存在的旧文件
          rm -f .yuuta.jks debug.keystore
          
          # 创建调试密钥库
          keytool -genkey -v \
            -keystore debug.keystore \
            -alias androiddebugkey \
            -storepass android \
            -keypass android \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US"
          
          # 复制为 .yuuta.jks
          cp debug.keystore .yuuta.jks
          
          echo "文件创建完成:"
          ls -la .yuuta.jks debug.keystore

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build debug APK
        run: |
          echo "构建调试版本..."
          
          # 只构建调试版本
          ./gradlew clean assembleDebug
          
          echo "构建完成，检查输出:"
          find . -name "*.apk" -type f 2>/dev/null | head -10

      - name: Find and collect APKs
        id: find-apks
        run: |
          echo "收集 APK 文件..."
          mkdir -p apk_output

          APK_COUNT=0
          # 优先查找 push 模块的 APK
          find push/build/outputs/apk -name "*.apk" -type f 2>/dev/null | while read -r apk_file; do
            echo "找到: $apk_file"
            cp "$apk_file" apk_output/
            APK_COUNT=$((APK_COUNT + 1))
          done

          if [ $APK_COUNT -eq 0 ]; then
            echo "在 push 模块中未找到 APK，尝试全项目查找..."
            find . -path "*/build/outputs/apk/*" -name "*.apk" -type f 2>/dev/null | while read -r apk_file; do
              echo "找到: $apk_file"
              cp "$apk_file" apk_output/
              APK_COUNT=$((APK_COUNT + 1))
            done
          fi

          if [ $APK_COUNT -eq 0 ]; then
            echo "警告: 未找到任何 APK 文件"
            echo "检查构建目录结构:"
            find . -name "build" -type d | head -10
          else
            echo "成功收集 $APK_COUNT 个 APK 文件"
            ls -la apk_output/
          fi

          echo "apk_count=$APK_COUNT" >> $GITHUB_OUTPUT

      - name: Upload APK artifacts
        if: steps.find-apks.outputs.apk_count > 0
        uses: actions/upload-artifact@v4
        with:
          name: apk-files-${{ github.run_number }}
          path: apk_output/
          retention-days: 7

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.run_number }}
          path: |
            **/build/outputs/logs/
            **/build/reports/
          retention-days: 7
