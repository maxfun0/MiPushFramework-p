name: Test CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-debug:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: gradle
    
    - name: Create signing files
      run: |
        echo "=== 创建签名文件 ==="
        
        # 创建项目期望的 .yuuta.jks 文件
        echo "创建 .yuuta.jks 文件..."
        touch .yuuta.jks
        
        # 创建调试密钥库
        echo "创建调试密钥库..."
        keytool -genkey -v -keystore debug.keystore \
          -storepass android -keypass android \
          -alias androiddebugkey -keyalg RSA \
          -keysize 2048 -validity 10000 \
          -dname "CN=Android Debug,O=Android,C=US" 2>/dev/null || echo "密钥库创建完成"
        
        # 创建 local.properties
        echo "创建 local.properties..."
        echo "key.alias=androiddebugkey" > local.properties
        echo "key.password=android" >> local.properties
        echo "key.store=debug.keystore" >> local.properties
        echo "key.store.password=android" >> local.properties
        
        echo "文件创建完成:"
        ls -la .yuuta.jks debug.keystore local.properties
    
    - name: Build debug APKs
      run: |
        echo "=== 开始构建 Debug APK ==="
        
        # 设置版本名
        VERSION_NAME="dev-$(date +%Y%m%d)-$(git rev-parse --short HEAD)"
        echo "版本: $VERSION_NAME"
        
        # 尝试多种构建方式
        
        echo "方式1: 构建所有 debug 变体..."
        ./gradlew assembleDebug -PversionName="$VERSION_NAME" --stacktrace || true
        
        echo "方式2: 构建特定模块..."
        ./gradlew :push:assembleDebug -PversionName="$VERSION_NAME" --stacktrace || true
        
        echo "方式3: 构建具体变体..."
        ./gradlew :push:assembleNormalDebug :push:assembleVc105Debug -PversionName="$VERSION_NAME" --stacktrace || true
    
    - name: Find APK files
      run: |
        echo "=== 查找 APK 文件 ==="
        
        echo "1. 在标准位置查找:"
        if [ -d "push/build/outputs/apk" ]; then
          echo "push/build/outputs/apk 目录存在"
          find push/build/outputs/apk -name "*.apk" -type f
        fi
        
        echo ""
        echo "2. 在所有位置查找:"
        find . -name "*.apk" -type f 2>/dev/null | head -20 || echo "未找到 APK 文件"
        
        echo ""
        echo "3. 目录结构:"
        ls -la push/build/outputs/apk/ 2>/dev/null || echo "push/build/outputs/apk 目录不存在"
    
    - name: Collect APKs
      run: |
        echo "=== 收集 APK 文件 ==="
        
        mkdir -p collected_apks
        
        # 从标准位置收集
        if [ -d "push/build/outputs/apk/normal/debug" ]; then
          echo "收集 normalDebug APK..."
          cp push/build/outputs/apk/normal/debug/*.apk collected_apks/ 2>/dev/null || true
        fi
        
        if [ -d "push/build/outputs/apk/vc105/debug" ]; then
          echo "收集 vc105Debug APK..."
          cp push/build/outputs/apk/vc105/debug/*.apk collected_apks/ 2>/dev/null || true
        fi
        
        # 如果没有收集到，尝试查找所有 debug APK
        if [ -z "$(ls -A collected_apks 2>/dev/null)" ]; then
          echo "从所有位置收集 debug APK..."
          find . -name "*debug*.apk" -type f -exec cp {} collected_apks/ \; 2>/dev/null || true
        fi
        
        echo "收集到的文件:"
        ls -la collected_apks/ || echo "无文件"
        
        # 检查文件数量
        COUNT=$(ls collected_apks/*.apk 2>/dev/null | wc -l || echo 0)
        echo "APK 数量: $COUNT"
        
        if [ $COUNT -eq 0 ]; then
          echo "警告: 未找到 APK 文件"
        fi
    
    - name: Upload APKs
      uses: actions/upload-artifact@v4
      with:
        name: debug-apks
        path: collected_apks/
        if-no-files-found: warn
