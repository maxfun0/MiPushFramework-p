name: Test CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-debug:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: gradle
    
    - name: Get version from git
      id: get-version
      run: |
        # 获取版本信息
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        COMMIT_COUNT=$(git rev-list --count HEAD)
        COMMIT_HASH=$(git rev-parse --short HEAD)
        VERSION="${LATEST_TAG}-${COMMIT_COUNT}-${COMMIT_HASH}"
        echo "Version: $VERSION"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Build Debug versions only
      run: |
        echo "Building Debug versions..."
        ./gradlew assembleDebug -PversionName=${{ steps.get-version.outputs.version }}
        
        echo "Build completed. Looking for APK files..."
        
        # 直接查找 push 模块的 debug APK
        if [ -d "push/build/outputs/apk" ]; then
          echo "Found push module APKs:"
          find push/build/outputs/apk -name "*.apk" -type f
          
          # 复制到统一目录
          mkdir -p debug_apks
          find push/build/outputs/apk -name "*debug*.apk" -type f -exec cp {} debug_apks/ \;
        else
          echo "push/build/outputs/apk not found, searching all APKs..."
          find . -name "*debug*.apk" -type f -exec cp {} debug_apks/ 2>/dev/null \;
        fi
        
        echo "Debug APKs collected:"
        ls -la debug_apks/ || echo "No debug APKs found"
    
    - name: Upload Debug APKs
      uses: actions/upload-artifact@v4
      with:
        name: debug-apks
        path: debug_apks/
        if-no-files-found: warn
