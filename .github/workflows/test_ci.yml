name: Android Simple Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
      
      - name: Create debug keystore
        run: |
          # 创建调试密钥库
          keytool -genkeypair -v \
            -keystore .yuuta.jks \
            -alias androiddebugkey \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass android \
            -keypass android \
            -dname "CN=Android Debug,O=Android,C=US"
          
          echo "密钥库创建完成:"
          ls -la .yuuta.jks
      
      - name: Setup Gradle
        run: |
          chmod +x gradlew
          echo "Gradle版本:"
          ./gradlew --version
      
      - name: Clean project
        run: |
          echo "清理项目..."
          ./gradlew clean
      
      - name: Try simple assemble
        run: |
          echo "尝试简单构建命令..."
          
          # 尝试最基本的构建命令
          ./gradlew assembleDebug 2>&1 | tee build.log
          
          # 检查是否成功
          if [ $? -eq 0 ]; then
            echo "构建成功！"
          else
            echo "构建失败，查看日志..."
            tail -100 build.log
            exit 1
          fi
      
      - name: Collect APKs
        if: success()
        run: |
          echo "收集APK文件..."
          mkdir -p artifacts
          
          # 查找所有APK文件
          find . -name "*.apk" -type f -exec cp {} artifacts/ \; 2>/dev/null || true
          
          echo "找到的文件:"
          ls -la artifacts/ || echo "没有找到APK文件"
      
      - name: Upload artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: apk-files
          path: artifacts/
          retention-days: 7
      
      - name: Upload build log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          retention-days: 7
